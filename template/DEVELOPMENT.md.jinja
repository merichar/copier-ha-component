# Development Guide for {{ component_name }}

This guide covers developing and testing this Home Assistant custom component.

## Table of Contents

- [Environment Setup](#environment-setup)
- [Project Structure](#project-structure)
- [Running Tests](#running-tests)
- [Manual Testing with Home Assistant](#manual-testing-with-home-assistant)
- [Code Quality](#code-quality)
- [Debugging](#debugging)
- [Adding Features](#adding-features)
- [Release Process](#release-process)

## Environment Setup

Choose one of three:

### Option A: Devcontainer in VS Code (Recommended)

Everything installs automatically (HA dev environment, Python 3.12, dependencies, pre-commit).

1. Install [Dev Containers extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)
2. Open this project in VS Code
3. Click "Reopen in Container" when prompted (or use Command Palette: "Dev Containers: Reopen in Container")
4. Wait for the container to build and dependencies to install

The devcontainer provides a consistent development environment with everything pre-configured.

### Option B: Standalone Docker

Use a containerized development environment without VS Code integration.

1. **Start the development container**:
   ```bash
   docker compose -f .devcontainer/docker-compose.yml up -d
   ```

2. **Enter the container**:
   ```bash
   docker compose -f .devcontainer/docker-compose.yml exec devcontainer bash
   ```

3. **Install dependencies** (inside container):
   ```bash
   uv pip install -e .[dev]
   ```

   *Note: pip users can substitute `uv pip` with `pip` in all commands.*

4. **Install pre-commit hooks** (inside container):
   ```bash
   pre-commit install
   ```

5. **Run tests** (inside container):
   ```bash
   pytest
   ```

6. **Exit container**:
   ```bash
   exit
   ```

7. **Stop container when done**:
   ```bash
   docker compose -f .devcontainer/docker-compose.yml down
   ```

Note: This uses the development container image. For running a full Home Assistant instance to manually test your component, see [Manual Testing with Home Assistant](#manual-testing-with-home-assistant).

### Option C: Manual Setup

Work directly on your host machine without containers.

1. **Install uv**
   ```bash
   # macOS/Linux
   curl -LsSf https://astral.sh/uv/install.sh | sh

   # Windows
   powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
   ```

   *Note: pip users can substitute `uv pip` with `pip` in all commands.*

2. **Create and activate virtual environment**:
   ```bash
   uv venv

   # Activate (choose based on your OS/shell)
   source .venv/bin/activate           # macOS/Linux (bash/zsh)
   source .venv/bin/activate.fish      # macOS/Linux (fish)
   .venv\Scripts\activate              # Windows (cmd)
   .venv\Scripts\Activate.ps1          # Windows (PowerShell)
   ```

3. **Install dependencies**:
   ```bash
   uv pip install -e .[dev]
   ```

4. **Install pre-commit hooks** (recommended):
   ```bash
   pre-commit install
   ```

## Project Structure

```
{{ repo_name }}/
├── .devcontainer/
│   ├── devcontainer.json       # VS Code devcontainer config
│   └── docker-compose.yml      # Development container setup
├── .editorconfig               # Editor-agnostic formatting rules
├── .gitignore
├── .pre-commit-config.yml      # Pre-commit hooks configuration
├── custom_components/
│   └── {{ component_slug }}/
│       ├── __init__.py          # Component setup and entry points
│       ├── manifest.json        # Component metadata and requirements
{% if include_config_flow %}│       ├── config_flow.py       # UI configuration flow
│       ├── strings.json         # Translations for config flow
{% endif %}│       └── [platforms]/        # Entity platforms (sensor, switch, etc.)
├── scripts/
│   └── check_version.py        # Version consistency checker
├── tests/
│   └── test_init.py            # Unit and integration tests
├── docker-compose.yml          # Run full HA instance for manual testing
├── hacs.json                   # HACS integration metadata
├── pyproject.toml              # Python project configuration
└── README.md                   # User-facing documentation
```

### Key Files

**manifest.json**
- Defines your component's metadata
- Lists required dependencies and minimum Home Assistant version
- Specifies IoT class (how the component communicates with devices)
{% if iot_class == 'decide_later' %}
- **TODO**: Update `iot_class` from `TODO_SET_IOT_CLASS` to the appropriate value
{% endif %}

**__init__.py**
- Entry point for your component
{% if include_config_flow %}- Sets up config entries and forwards to platforms
{% else %}- Sets up component from YAML configuration
{% endif %}- Handles component lifecycle (setup, unload)

{% if include_config_flow %}**config_flow.py**
- Handles UI-based configuration flow
- Validates user input and creates config entries
- Provides a better user experience than YAML configuration

**strings.json**
- Provides translations for the config flow UI
- Currently only English, but can be expanded to other languages
{% endif %}

**hacs.json**
- HACS integration metadata
- Makes component discoverable in HACS
- Already configured with your component name

## Running Tests

Tests use pytest with Home Assistant test fixtures.

### Run all tests:
```bash
pytest
```

### Run specific test file:
```bash
pytest tests/test_init.py
```

### Run with coverage:
```bash
pytest --cov=custom_components.{{ component_slug }} --cov-report=html
```
Then open `htmlcov/index.html` in your browser to see coverage details.

### Run with verbose output:
```bash
pytest -v
```

### Writing Tests

Tests should cover:
- Component setup and teardown
{% if include_config_flow %}- Config flow validation
- Config entry setup/unload
{% endif %}- Entity state and attributes
- Service calls
- Error handling

Example test structure:
```python
async def test_sensor_state(hass: HomeAssistant) -> None:
    """Test sensor reports correct state."""
    # Arrange: Set up component and entities
    # Act: Trigger state update
    # Assert: Verify correct behavior
```

## Manual Testing with Home Assistant

For testing your component in a real Home Assistant instance:

### Using Docker Compose

1. **Start Home Assistant**:
   ```bash
   docker compose up -d
   ```

   This starts a full Home Assistant instance with your component automatically mounted.

2. **Access Home Assistant**:
   - Open http://localhost:8123
   - Complete the initial setup
   - Your component is automatically available as a custom component

3. **View logs**:
   ```bash
   docker compose logs -f homeassistant
   ```

   Press Ctrl+C to stop following logs.

4. **Restart after code changes**:
   ```bash
   docker compose restart homeassistant
   ```

5. **Stop Home Assistant**:
   ```bash
   docker compose down
   ```

### Configuration

{% if include_config_flow %}Your component uses config flow, so add it via the UI:
1. Go to Settings -> Devices & Services
2. Click "+ Add Integration"
3. Search for "{{ component_name }}"
4. Follow the configuration steps

Alternatively, you can configure via YAML in `config/configuration.yaml`:
```yaml
{{ component_slug }}:
  # Configuration options
```
{% else %}Add to your `config/configuration.yaml`:
```yaml
{{ component_slug }}:
  # Add your configuration here
```
{% endif %}

Restart Home Assistant after making configuration changes.

### Manual Installation to Existing HA

If you have an existing Home Assistant installation:

1. Copy `custom_components/{{ component_slug }}` to your HA config directory:
   ```
   /config/custom_components/{{ component_slug }}/
   ```

2. Restart Home Assistant

3. Check logs for any errors:
   ```
   Settings -> System -> Logs
   ```

## Code Quality

This project uses several tools to maintain code quality and consistency.

### Pre-commit Hooks

Pre-commit hooks automatically check your code before each commit.

**What pre-commit checks**:
- **Ruff**: Linting and formatting
- **File validation**: Trailing whitespace, end-of-file newlines, YAML/JSON syntax
- **Codespell**: Common spelling mistakes
- **Version check**: Warns if `manifest.json` version doesn't match latest git tag

**Install hooks** (if not already done during setup):
```bash
pre-commit install
```

**Run manually** on all files:
```bash
pre-commit run --all-files
```

Once installed, pre-commit runs automatically on `git commit`. If issues are found, fix them and commit again.

### Ruff (Linting and Formatting)

Check for issues:
```bash
ruff check .
```

Auto-fix issues:
```bash
ruff check --fix .
```

Format code:
```bash
ruff format .
```

## Debugging

### Debug Logging

Enable debug logging for your component in `configuration.yaml`:

```yaml
logger:
  default: info
  logs:
    custom_components.{{ component_slug }}: debug
```

This will show detailed debug messages in your Home Assistant logs.

### Debugging Tests

Run with the `-s` flag to see print statements:
```bash
pytest -s
```

Or use pytest's built-in debugger:
```bash
pytest --pdb  # Drop into debugger on failures
```

## Adding Features

### Adding a Platform (Sensor, Switch, etc.)

1. Create platform file: `custom_components/{{ component_slug }}/sensor.py`

2. Basic sensor example:
```python
"""Sensor platform for {{ component_name }}."""
from homeassistant.components.sensor import SensorEntity
from homeassistant.core import HomeAssistant
from homeassistant.helpers.entity_platform import AddEntitiesCallback
{% if include_config_flow %}from homeassistant.config_entries import ConfigEntry


async def async_setup_entry(
    hass: HomeAssistant,
    entry: ConfigEntry,
    async_add_entities: AddEntitiesCallback,
) -> None:
    """Set up {{ component_name }} sensor from a config entry."""
    async_add_entities([ExampleSensor()])
{% else %}

def setup_platform(hass, config, add_entities, discovery_info=None):
    """Set up the {{ component_name }} sensor platform."""
    add_entities([ExampleSensor()])
{% endif %}


class ExampleSensor(SensorEntity):
    """Example sensor."""

    def __init__(self):
        """Initialize the sensor."""
        self._attr_name = "Example Sensor"
        self._attr_unique_id = "{{ component_slug }}_example"

    @property
    def state(self):
        """Return the state of the sensor."""
        return "example_value"
```

3. {% if include_config_flow %}Update `PLATFORMS` in `__init__.py`:
```python
PLATFORMS = ["sensor"]  # Add your platforms here
```
{% else %}Your platform will be loaded via YAML configuration.{% endif %}

4. Write tests in `tests/test_sensor.py`

### Adding a Service

1. Define service in `services.yaml`:
```yaml
my_service:
  name: My Service
  description: Does something useful
  fields:
    entity_id:
      description: Entity to control
      example: "sensor.example"
```

2. Register service in `__init__.py`:
```python
async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Set up from a config entry."""

    async def handle_my_service(call):
        """Handle the service call."""
        entity_id = call.data.get("entity_id")
        # Service logic here

    hass.services.async_register("{{ component_slug }}", "my_service", handle_my_service)
    return True
```

## Release Process

### Versioning

Follow [Semantic Versioning](https://semver.org/):
- MAJOR version for incompatible API changes
- MINOR version for new functionality
- PATCH version for bug fixes

### Creating a Release

1. **Update version** in `manifest.json`:
   ```json
   {
     "version": "X.Y.Z"
   }
   ```

2. **Tag release**:
   ```bash
   git tag -a vX.Y.Z -m "Release version X.Y.Z"
   ```

3. **Push to {{ vcs_name }}**:
   ```bash
   git push origin main --tags
   ```

4. **Create release** on {{ vcs_name }}:
   - Go to your repository
   - Create a new release from your tag
   - Add release notes
   - Publish release

### Publishing to HACS

1. **Ensure your repository has**:
   - Version in `manifest.json`
   - `README.md` with installation instructions
   - At least one release with a version tag

2. **Create your first release** (see steps above)

3. **Submit to HACS default repository** (optional):
   - Follow [HACS submission guidelines](https://hacs.xyz/docs/publish/start)
   - Repository must be public
   - Requires at least one release

### Installing Your Component

Users can install the component via HACS or manually. See the [README.md](README.md) for complete installation instructions.

## Resources

### Home Assistant Development

- [Home Assistant Developer Docs](https://developers.home-assistant.io/)
- [Integration Development Checklist](https://developers.home-assistant.io/docs/development_checklist)
- [Entity Documentation](https://developers.home-assistant.io/docs/core/entity)
- [Config Entries](https://developers.home-assistant.io/docs/config_entries_index)

### Tools

- [Ruff Documentation](https://docs.astral.sh/ruff/)
- [pytest Documentation](https://docs.pytest.org/)
- [pytest-homeassistant-custom-component](https://github.com/MatthewFlamm/pytest-homeassistant-custom-component)
- [uv Documentation](https://docs.astral.sh/uv/)
- [Pre-commit Documentation](https://pre-commit.com/)

## Getting Help

- [Home Assistant Community Forum](https://community.home-assistant.io/)
- [Home Assistant Discord](https://discord.gg/home-assistant)
- [Component Repository]({{ vcs_uri_prefix }}{{ git_username }}/{{ repo_name }}/issues) - Report issues or request features
